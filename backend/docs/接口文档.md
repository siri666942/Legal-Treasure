# 律宝小队 后端接口文档

> 版本：v1.0  
> 基础URL：`http://127.0.0.1:8000`  
> API前缀：`/api/v1`

---

## 目录

1. [概述](#概述)
2. [通用说明](#通用说明)
3. [接口列表](#接口列表)
   - [健康检查](#0-健康检查)
   - [用户认证模块](#1-用户认证模块-auth)
   - [文件管理模块](#2-文件管理模块-files)
   - [查询模块](#3-查询模块-query)
4. [错误码说明](#错误码说明)
5. [前端调用示例](#前端调用示例)

---

## 概述

本文档为「律宝小队」项目的后端 API 接口文档，旨在帮助前后端开发人员快速理解和对接接口。

**主要功能模块：**
| 模块 | 说明 |
|------|------|
| 用户认证 (auth) | 用户注册、登录、获取Token |
| 文件管理 (files) | 文件上传、文件列表查询 |
| 查询 (query) | 合同列表查询、法条搜索 |

---

## 通用说明

### 1. 请求格式

- **Content-Type**: `application/json`（除文件上传外）
- **文件上传**: `multipart/form-data`

### 2. 认证方式

需要认证的接口必须在请求头中携带 Token：

```
Authorization: Bearer <access_token>
```

### 3. 响应格式

所有接口返回 JSON 格式数据。

**成功响应示例：**
```json
{
  "id": 1,
  "username": "alice",
  "email": "alice@example.com"
}
```

**错误响应示例：**
```json
{
  "detail": "用户名或密码错误"
}
```

### 4. 状态码说明

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未授权（Token无效或过期） |
| 404 | 资源不存在 |
| 422 | 请求数据格式/校验错误 |
| 500 | 服务器内部错误 |

---

## 接口列表

---

### 0. 健康检查

#### `GET /health`

**接口说明：** 检查服务是否正常运行，用于负载均衡健康检查或前端判断后端是否可用。

**是否需要认证：** ❌ 否

**请求参数：** 无

**响应示例：**
```json
{
  "status": "ok"
}
```

**前端使用场景：**
- 页面加载时检测后端服务状态
- 定时心跳检测

---

### 1. 用户认证模块 (auth)

#### 1.1 用户注册

##### `POST /api/v1/auth/register`

**接口说明：** 新用户注册账号。注册成功后返回用户信息（不含密码）。

**是否需要认证：** ❌ 否

**请求头：**
```
Content-Type: application/json
```

**请求参数（Body - JSON）：**

| 字段名 | 类型 | 必填 | 说明 | 限制 |
|--------|------|------|------|------|
| username | string | ✅ 是 | 用户名 | 3-50 字符 |
| password | string | ✅ 是 | 密码 | 6-128 字符 |
| email | string | ❌ 否 | 邮箱地址 | 邮箱格式 |

**请求示例：**
```json
{
  "username": "alice",
  "password": "123456",
  "email": "alice@example.com"
}
```

**响应参数：**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 用户ID |
| username | string | 用户名 |
| email | string \| null | 邮箱地址 |

**响应示例（成功 - 200）：**
```json
{
  "id": 1,
  "username": "alice",
  "email": "alice@example.com"
}
```

**错误响应（400）：**
```json
{
  "detail": "用户名或邮箱已存在"
}
```

**前端使用场景：**
- 注册页面提交表单
- 注册成功后可引导用户登录

---

#### 1.2 用户登录（JSON方式）

##### `POST /api/v1/auth/login`

**接口说明：** 用户使用用户名和密码登录，登录成功后返回 JWT Token。前端需保存此 Token 用于后续接口调用。

**是否需要认证：** ❌ 否

**请求头：**
```
Content-Type: application/json
```

**请求参数（Body - JSON）：**

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| username | string | ✅ 是 | 用户名 |
| password | string | ✅ 是 | 密码 |

**请求示例：**
```json
{
  "username": "alice",
  "password": "123456"
}
```

**响应参数：**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| access_token | string | JWT访问令牌 |
| token_type | string | 令牌类型，固定为 "bearer" |

**响应示例（成功 - 200）：**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

**错误响应（400）：**
```json
{
  "detail": "用户名或密码错误"
}
```

**前端使用场景：**
- 登录页面提交表单
- 登录成功后将 `access_token` 存储到 localStorage 或 sessionStorage
- 后续请求在 Header 中携带 Token

**Token 使用方式：**
```javascript
// 存储 Token
localStorage.setItem('token', response.access_token);

// 请求时携带 Token
fetch('/api/v1/files', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
});
```

---

#### 1.3 用户登录（OAuth2表单方式）

##### `POST /api/v1/auth/token`

**接口说明：** OAuth2 标准表单登录方式，主要用于 Swagger UI 的「Authorize」按钮授权。功能与 `/login` 相同，但请求格式为表单。

**是否需要认证：** ❌ 否

**请求头：**
```
Content-Type: application/x-www-form-urlencoded
```

**请求参数（Body - Form）：**

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| username | string | ✅ 是 | 用户名 |
| password | string | ✅ 是 | 密码 |

**响应参数：** 同 `/login` 接口

**前端使用场景：**
- 一般情况下前端使用 `/login` 接口即可
- 此接口主要供 Swagger 文档测试使用

---

### 2. 文件管理模块 (files)

#### 2.1 文件上传

##### `POST /api/v1/files/upload`

**接口说明：** 上传文件到服务器。上传的文件会存储到服务器指定目录，并在数据库中创建文件记录，与当前登录用户关联。

**是否需要认证：** ✅ 是

**请求头：**
```
Authorization: Bearer <access_token>
Content-Type: multipart/form-data
```

**请求参数（Body - FormData）：**

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | File | ✅ 是 | 要上传的文件 |

**响应参数：**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 文件记录ID |
| original_filename | string | 原始文件名 |
| stored_filename | string | 服务器存储的文件名（UUID前缀） |
| content_type | string \| null | 文件MIME类型 |
| size | integer | 文件大小（字节） |
| path | string | 文件存储路径 |
| created_at | string | 创建时间（ISO 8601格式） |

**响应示例（成功 - 200）：**
```json
{
  "id": 1,
  "original_filename": "合同样本.pdf",
  "stored_filename": "644244a187a246cf96d3d58590fd6382_合同样本.pdf",
  "content_type": "application/pdf",
  "size": 102400,
  "path": ".\\uploads\\644244a187a246cf96d3d58590fd6382_合同样本.pdf",
  "created_at": "2026-01-25T10:30:00.000000"
}
```

**错误响应（401）：**
```json
{
  "detail": "Not authenticated"
}
```

**前端使用场景：**
- 合同上传功能
- 文件上传组件

**前端调用示例：**
```javascript
const formData = new FormData();
formData.append('file', fileInput.files[0]);

fetch('/api/v1/files/upload', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`
  },
  body: formData
});
```

---

#### 2.2 获取我的文件列表

##### `GET /api/v1/files`

**接口说明：** 获取当前登录用户上传的所有文件列表，按上传时间倒序排列（最新的在前）。

**是否需要认证：** ✅ 是

**请求头：**
```
Authorization: Bearer <access_token>
```

**请求参数：** 无

**响应参数：** 文件对象数组

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 文件记录ID |
| original_filename | string | 原始文件名 |
| stored_filename | string | 服务器存储的文件名 |
| content_type | string \| null | 文件MIME类型 |
| size | integer | 文件大小（字节） |
| path | string | 文件存储路径 |
| created_at | string | 创建时间 |

**响应示例（成功 - 200）：**
```json
[
  {
    "id": 2,
    "original_filename": "租房合同.docx",
    "stored_filename": "f0a7050befaf44c5bcc67033668ec9cc_租房合同.docx",
    "content_type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "size": 51200,
    "path": ".\\uploads\\f0a7050befaf44c5bcc67033668ec9cc_租房合同.docx",
    "created_at": "2026-01-25T11:00:00.000000"
  },
  {
    "id": 1,
    "original_filename": "合同样本.pdf",
    "stored_filename": "644244a187a246cf96d3d58590fd6382_合同样本.pdf",
    "content_type": "application/pdf",
    "size": 102400,
    "path": ".\\uploads\\644244a187a246cf96d3d58590fd6382_合同样本.pdf",
    "created_at": "2026-01-25T10:30:00.000000"
  }
]
```

**前端使用场景：**
- 「我的文件」页面展示文件列表
- 文件管理功能

---

### 3. 查询模块 (query)

#### 3.1 获取我的合同列表

##### `GET /api/v1/query/contracts`

**接口说明：** 查询当前登录用户的合同列表，支持按关键字搜索和状态筛选。

**是否需要认证：** ✅ 是

**请求头：**
```
Authorization: Bearer <access_token>
```

**请求参数（Query String）：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| q | string | ❌ 否 | 搜索关键字，匹配标题或描述 |
| status | string | ❌ 否 | 合同状态过滤 |

**请求示例：**
```
GET /api/v1/query/contracts?q=租房&status=active
```

**响应参数：** 合同对象数组

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 合同ID |
| title | string | 合同标题 |
| description | string \| null | 合同描述 |
| status | string | 合同状态 |
| file_id | integer \| null | 关联的文件ID |
| created_at | string | 创建时间 |

**响应示例（成功 - 200）：**
```json
[
  {
    "id": 1,
    "title": "房屋租赁合同",
    "description": "北京市朝阳区XX小区租房合同",
    "status": "active",
    "file_id": 1,
    "created_at": "2026-01-25T09:00:00.000000"
  }
]
```

**前端使用场景：**
- 「我的合同」页面展示合同列表
- 合同搜索和筛选功能

**合同状态值说明（参考）：**
| 状态值 | 说明 |
|--------|------|
| draft | 草稿 |
| active | 生效中 |
| expired | 已过期 |
| terminated | 已终止 |

---

#### 3.2 法条搜索

##### `GET /api/v1/query/laws`

**接口说明：** 搜索法律条文，支持按法律名称和内容关键字搜索。此接口不需要登录，任何人都可以访问。

**是否需要认证：** ❌ 否

**请求参数（Query String）：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| keyword | string | ❌ 否 | 内容关键字搜索 |
| law_name | string | ❌ 否 | 法律名称过滤（精确匹配） |

**请求示例：**
```
GET /api/v1/query/laws?keyword=租赁&law_name=民法典
```

**响应参数：** 法条对象数组（最多返回50条）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 法条ID |
| law_name | string | 法律名称 |
| article_no | string \| null | 条款编号 |
| content | string | 法条内容 |
| created_at | string | 创建时间 |

**响应示例（成功 - 200）：**
```json
[
  {
    "id": 1,
    "law_name": "民法典",
    "article_no": "第七百零三条",
    "content": "租赁合同是出租人将租赁物交付承租人使用、收益，承租人支付租金的合同。",
    "created_at": "2026-01-20T00:00:00.000000"
  },
  {
    "id": 2,
    "law_name": "民法典",
    "article_no": "第七百零四条",
    "content": "租赁合同的内容一般包括租赁物的名称、数量、用途、租赁期限、租金及其支付期限和方式、租赁物维修等条款。",
    "created_at": "2026-01-20T00:00:00.000000"
  }
]
```

**前端使用场景：**
- 法律咨询功能
- 法条检索页面
- 合同审核时参考相关法条

---

## 错误码说明

### HTTP 状态码

| 状态码 | 说明 | 常见原因 |
|--------|------|----------|
| 200 | 成功 | 请求正常处理 |
| 400 | 请求错误 | 用户名已存在、密码错误等业务逻辑错误 |
| 401 | 未授权 | Token 无效、过期或未提供 |
| 404 | 未找到 | 请求的资源不存在 |
| 422 | 验证错误 | 请求参数格式错误、必填字段缺失 |
| 500 | 服务器错误 | 后端内部错误 |

### 常见业务错误

| 错误信息 | 说明 | 解决方案 |
|----------|------|----------|
| 用户名或邮箱已存在 | 注册时用户名或邮箱已被使用 | 更换用户名或邮箱 |
| 用户名或密码错误 | 登录时凭据不正确 | 检查用户名和密码 |
| Not authenticated | 未提供有效的认证信息 | 检查是否携带 Token |
| Could not validate credentials | Token 无效或已过期 | 重新登录获取新 Token |

---

## 前端调用示例

### JavaScript/Fetch 示例

#### 1. 用户注册
```javascript
async function register(username, password, email) {
  const response = await fetch('http://127.0.0.1:8000/api/v1/auth/register', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ username, password, email })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail);
  }
  
  return response.json();
}
```

#### 2. 用户登录
```javascript
async function login(username, password) {
  const response = await fetch('http://127.0.0.1:8000/api/v1/auth/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ username, password })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail);
  }
  
  const data = await response.json();
  // 保存 Token
  localStorage.setItem('access_token', data.access_token);
  return data;
}
```

#### 3. 获取 Token 的辅助函数
```javascript
function getAuthHeaders() {
  const token = localStorage.getItem('access_token');
  return {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  };
}
```

#### 4. 上传文件
```javascript
async function uploadFile(file) {
  const formData = new FormData();
  formData.append('file', file);
  
  const token = localStorage.getItem('access_token');
  const response = await fetch('http://127.0.0.1:8000/api/v1/files/upload', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail);
  }
  
  return response.json();
}
```

#### 5. 获取文件列表
```javascript
async function getMyFiles() {
  const response = await fetch('http://127.0.0.1:8000/api/v1/files', {
    headers: getAuthHeaders()
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail);
  }
  
  return response.json();
}
```

#### 6. 查询合同
```javascript
async function getContracts(q = '', status = '') {
  const params = new URLSearchParams();
  if (q) params.append('q', q);
  if (status) params.append('status', status);
  
  const url = `http://127.0.0.1:8000/api/v1/query/contracts?${params}`;
  const response = await fetch(url, {
    headers: getAuthHeaders()
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail);
  }
  
  return response.json();
}
```

#### 7. 搜索法条
```javascript
async function searchLaws(keyword = '', lawName = '') {
  const params = new URLSearchParams();
  if (keyword) params.append('keyword', keyword);
  if (lawName) params.append('law_name', lawName);
  
  const url = `http://127.0.0.1:8000/api/v1/query/laws?${params}`;
  const response = await fetch(url);
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail);
  }
  
  return response.json();
}
```

---

## Swagger 自动文档

后端服务启动后，可访问以下地址查看交互式 API 文档：

- **Swagger UI**: http://127.0.0.1:8000/docs
- **ReDoc**: http://127.0.0.1:8000/redoc
- **OpenAPI JSON**: http://127.0.0.1:8000/openapi.json

在 Swagger UI 中可以：
1. 点击「Authorize」按钮输入 Token 进行授权
2. 直接测试各个接口
3. 查看请求/响应的详细格式

---

## 接口速查表

| 接口 | 方法 | 路径 | 认证 | 说明 |
|------|------|------|------|------|
| 健康检查 | GET | `/health` | ❌ | 检测服务状态 |
| 用户注册 | POST | `/api/v1/auth/register` | ❌ | 新用户注册 |
| 用户登录 | POST | `/api/v1/auth/login` | ❌ | JSON方式登录 |
| 获取Token | POST | `/api/v1/auth/token` | ❌ | OAuth2表单登录 |
| 上传文件 | POST | `/api/v1/files/upload` | ✅ | 上传文件 |
| 文件列表 | GET | `/api/v1/files` | ✅ | 获取我的文件 |
| 合同列表 | GET | `/api/v1/query/contracts` | ✅ | 查询我的合同 |
| 法条搜索 | GET | `/api/v1/query/laws` | ❌ | 搜索法律条文 |

---

*文档更新时间：2026-01-25*
