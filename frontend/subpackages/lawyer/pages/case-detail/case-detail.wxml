<view class="container">
  <!-- æ¡ˆä»¶æ ‡é¢˜å’Œæ“ä½œ -->
  <view class="case-header">
    <view class="case-title-row">
      <text class="case-title">{{caseInfo.caseTitle}}</text>
    </view>
    <view class="case-no-row">
      <text class="case-no">{{caseInfo.caseNo}}</text>
      <text class="copy-icon" bindtap="copyCaseNo">ğŸ“‹</text>
    </view>
  </view>

  <!-- æ¡ˆä»¶åŸºæœ¬ä¿¡æ¯ -->
  <view class="card">
    <view class="card-header">
      <view class="card-title-with-icon">
        <view class="card-icon">
          <text class="icon">ğŸ“‹</text>
        </view>
        <text class="card-title">æ¡ˆä»¶åŸºæœ¬ä¿¡æ¯</text>
      </view>
    </view>
    <view class="card-content">
      <view class="info-grid">
        <view class="info-item">
          <text class="label">æ¡ˆå·ï¼š</text>
          <text class="value">{{caseInfo.caseNo}}</text>
        </view>
        <view class="info-item">
          <text class="label">æ¡ˆä»¶æ€§è´¨ï¼š</text>
          <text class="value">{{caseInfo.caseType}}</text>
        </view>
        <view class="info-item">
          <text class="label">å—ç†æ³•é™¢ï¼š</text>
          <text class="value">{{caseInfo.court}}</text>
        </view>
        <view class="info-item">
          <text class="label">æ‰¿åŠæ³•å®˜ï¼š</text>
          <text class="value">{{caseInfo.judge}}</text>
        </view>
        <view class="info-item">
          <text class="label">ç«‹æ¡ˆæ—¶é—´ï¼š</text>
          <text class="value">{{caseInfo.filingDate}}</text>
        </view>
        <view class="info-item">
          <text class="label">å½“å‰çŠ¶æ€ï¼š</text>
          <view class="status-badge status-active">å®¡ç†ä¸­</view>
        </view>
        <view class="info-item">
          <text class="label">æ ‡çš„é‡‘é¢ï¼š</text>
          <text class="value">{{caseInfo.amount}}</text>
        </view>
        <view class="info-item">
          <text class="label">é€‚ç”¨æ³•å¾‹ï¼š</text>
          <text class="value">{{caseInfo.applicableLaw}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ¡ˆä»¶æ—¶é—´è½´ï¼ˆå¯ç¼–è¾‘ï¼‰ -->
  <view class="card collapsible-card">
    <view class="card-header" bindtap="toggleTimeline">
      <view class="card-title-with-icon">
        <view class="card-icon">
          <text class="icon">ğŸ“…</text>
        </view>
        <text class="card-title">æ¡ˆä»¶æ—¶é—´è½´</text>
      </view>
      <view class="header-actions">
        <view wx:if="{{timelineExpanded && !timelineEditing}}" class="edit-btn" catchtap="startEditTimeline">
          <text class="icon">âœï¸</text>
        </view>
        <view class="collapse-icon">
          <text class="icon">{{timelineExpanded ? 'â–²' : 'â–¼'}}</text>
          <text class="collapse-text">{{timelineExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
        </view>
      </view>
    </view>

    <!-- å±•å¼€ + æŸ¥çœ‹æ¨¡å¼ -->
    <view wx:if="{{timelineExpanded && !timelineEditing}}" class="card-content">
      <view class="timeline">
        <view class="timeline-item" wx:for="{{timeline}}" wx:key="index">
          <view class="timeline-dot {{item.status}}"></view>
          <view class="timeline-content">
            <view class="timeline-date">{{item.date}}</view>
            <view class="timeline-event">{{item.event}}</view>
            <view class="timeline-desc" wx:if="{{item.description}}">{{item.description}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- å±•å¼€ + ç¼–è¾‘æ¨¡å¼ -->
    <view wx:if="{{timelineExpanded && timelineEditing}}" class="card-content">
      <view class="editable-list">
        <view class="list-header">
          <text class="list-title">ç¼–è¾‘æ—¶é—´è½´</text>
        </view>
        <view class="list-items">
          <view class="editable-item" wx:for="{{timeline}}" wx:key="index">
            <view class="item-content">
              <text class="item-date">{{item.date}}</text>
              <text class="item-event">{{item.event}}</text>
              <text class="item-desc" wx:if="{{item.description}}">{{item.description}}</text>
            </view>
            <view class="item-actions">
              <text class="delete-btn" bindtap="deleteTimelineItem" data-index="{{index}}">ğŸ—‘ï¸</text>
            </view>
          </view>
        </view>

        <!-- æ·»åŠ æŒ‰é’® -->
        <view wx:if="{{!showTimelineAddForm}}" class="add-trigger" bindtap="showTimelineAdd">
          <text class="add-trigger-icon">ï¼‹</text>
          <text class="add-trigger-text">æ·»åŠ æ—¶é—´è½´</text>
        </view>

        <!-- æ·»åŠ è¡¨å• -->
        <view wx:if="{{showTimelineAddForm}}" class="add-form">
          <view class="form-row">
            <picker mode="date" bindchange="onTimelineDateChange">
              <view class="picker-input">
                {{newTimelineItem.date || 'é€‰æ‹©æ—¥æœŸ'}}
              </view>
            </picker>
          </view>
          <view class="form-row">
            <input class="add-input" placeholder="äº‹ä»¶" value="{{newTimelineItem.event}}" bindinput="onTimelineEventInput" />
          </view>
          <view class="form-row">
            <input class="add-input" placeholder="æè¿°ï¼ˆå¯é€‰ï¼‰" value="{{newTimelineItem.description}}" bindinput="onTimelineDescInput" />
          </view>
          <view class="form-actions">
            <view class="cancel-small-btn" bindtap="hideTimelineAdd">å–æ¶ˆ</view>
            <view class="confirm-small-btn" bindtap="addTimelineItem">ç¡®è®¤</view>
          </view>
        </view>

        <view class="edit-actions">
          <view class="cancel-btn" bindtap="cancelEditTimeline">å–æ¶ˆ</view>
          <view class="save-btn" bindtap="saveEditTimeline">ä¿å­˜</view>
        </view>
      </view>
    </view>

    <!-- æŠ˜å çŠ¶æ€ - åŠ¨æ€ç®€ç•¥æ˜¾ç¤ºï¼ˆå‰4æ¡ï¼‰ -->
    <view class="collapsed-content" wx:else>
      <view class="collapsed-items">
        <view class="collapsed-item" wx:for="{{timeline.slice(0,4)}}" wx:key="index">
          <view class="collapsed-dot {{item.status}}"></view>
          <text class="collapsed-text">{{item.date}} {{item.event}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å…³è”å·å®—ï¼ˆå¯ç¼–è¾‘ + çœŸå®æ–‡ä»¶æ“ä½œï¼Œå³ä¾§â€œâ‹¯â€èœå•ï¼‰ -->
  <view class="card collapsible-card">
    <view class="card-header" bindtap="toggleDocuments">
      <view class="card-title-with-icon">
        <view class="card-icon">
          <text class="icon">ğŸ“</text>
        </view>
        <text class="card-title">å…³è”å·å®—</text>
      </view>
      <view class="header-actions">
        <view wx:if="{{documentsExpanded && !documentsEditing}}" class="edit-btn" catchtap="startEditDocuments">
          <text class="icon">âœï¸</text>
        </view>
        <view class="collapse-icon">
          <text class="icon">{{documentsExpanded ? 'â–²' : 'â–¼'}}</text>
          <text class="collapse-text">{{documentsExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
        </view>
      </view>
    </view>

    <!-- å±•å¼€ + æŸ¥çœ‹æ¨¡å¼ï¼ˆå³ä¾§â€œâ‹¯â€èœå•ï¼‰ -->
    <view wx:if="{{documentsExpanded && !documentsEditing}}" class="card-content">
      <view class="documents-grid">
        <view class="document-item" wx:for="{{documents}}" wx:key="index">
          <view class="document-info">
            <text class="document-name">{{item.name}}</text>
            <text class="document-meta">{{item.type}} â€¢ {{item.size}} â€¢ {{item.date}}</text>
            <text class="document-uploader">ä¸Šä¼ ï¼š{{item.uploadedBy}}</text>
          </view>
          <!-- å³ä¾§â€œâ‹¯â€èœå• -->
          <view class="document-more" bindtap="showFileActions" data-index="{{index}}">
            <text>â‹¯</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å±•å¼€ + ç¼–è¾‘æ¨¡å¼ï¼ˆæ— è¾“å…¥æ¡†ï¼Œç›´æ¥ä¸Šä¼ ï¼‰ -->
    <view wx:if="{{documentsExpanded && documentsEditing}}" class="card-content">
      <view class="editable-list">
        <view class="list-header">
          <text class="list-title">ç¼–è¾‘å·å®—</text>
        </view>
        <view class="list-items">
          <view class="editable-item" wx:for="{{documents}}" wx:key="index">
            <view class="item-content">
              <text class="item-name">{{item.name}}</text>
              <text class="item-meta">{{item.type}} â€¢ {{item.size}} â€¢ {{item.date}}</text>
              <text class="item-sub">ä¸Šä¼ ï¼š{{item.uploadedBy}}</text>
            </view>
            <view class="item-actions">
              <text class="delete-btn" bindtap="deleteDocumentItem" data-index="{{index}}">ğŸ—‘ï¸</text>
            </view>
          </view>
        </view>

        <!-- ç›´æ¥æ˜¾ç¤ºâ€œé€‰æ‹©æ–‡ä»¶ä¸Šä¼ â€æŒ‰é’® -->
        <view class="upload-file-btn" bindtap="uploadDocumentFile">é€‰æ‹©æ–‡ä»¶ä¸Šä¼ </view>

        <view class="edit-actions">
          <view class="cancel-btn" bindtap="cancelEditDocuments">å–æ¶ˆ</view>
          <view class="save-btn" bindtap="saveEditDocuments">ä¿å­˜</view>
        </view>
      </view>
    </view>

    <!-- æŠ˜å çŠ¶æ€ - åŠ¨æ€ç®€ç•¥æ˜¾ç¤ºï¼ˆå‰3æ¡ï¼‰ -->
    <view class="collapsed-content" wx:else>
      <view class="collapsed-items">
        <view class="collapsed-item" wx:for="{{documents.slice(0,3)}}" wx:key="index">
          <text class="collapsed-text">{{item.name}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ¡ˆä»¶ç›¸å…³æ–¹ï¼ˆå¯ç¼–è¾‘ï¼Œè”ç³»æŒ‰é’®ç›´æ¥æ‹¨å·ï¼‰ -->
  <view class="card collapsible-card">
    <view class="card-header" bindtap="toggleParties">
      <view class="card-title-with-icon">
        <view class="card-icon">
          <text class="icon">ğŸ‘¥</text>
        </view>
        <text class="card-title">æ¡ˆä»¶ç›¸å…³æ–¹</text>
      </view>
      <view class="header-actions">
        <view wx:if="{{partiesExpanded && !partiesEditing}}" class="edit-btn" catchtap="startEditParties">
          <text class="icon">âœï¸</text>
        </view>
        <view class="collapse-icon">
          <text class="icon">{{partiesExpanded ? 'â–²' : 'â–¼'}}</text>
          <text class="collapse-text">{{partiesExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
        </view>
      </view>
    </view>

    <!-- å±•å¼€ + æŸ¥çœ‹æ¨¡å¼ï¼ˆè”ç³»æŒ‰é’®ï¼‰ -->
    <view wx:if="{{partiesExpanded && !partiesEditing}}" class="card-content">
      <view class="parties-container">
        <view class="party-card" wx:for="{{parties}}" wx:key="id">
          <view class="party-header">
            <view class="party-avatar {{item.roleClass}}">
              <text>{{item.id}}</text>
            </view>
            <view class="party-title">
              <text class="party-name">{{item.name}}</text>
              <text class="party-type">{{item.type}}</text>
            </view>
          </view>
          <view class="party-details">
            <text class="party-role">{{item.role}}</text>
            <text class="party-contact" wx:if="{{item.contact}}">{{item.contact}}</text>
            <text class="party-address" wx:if="{{item.address}}">{{item.address}}</text>
          </view>
          <!-- è”ç³»æŒ‰é’®ï¼ˆç”µè¯å›¾æ ‡ï¼‰ -->
          <view class="party-action">
            <view wx:if="{{item.contact}}" class="contact-btn" bindtap="callParty" data-index="{{index}}">
              <text class="btn-text">è”ç³»</text>
            </view>
            <view wx:else class="contact-btn disabled">
              <text class="btn-text">æ— è”ç³»æ–¹å¼</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å±•å¼€ + ç¼–è¾‘æ¨¡å¼ -->
    <view wx:if="{{partiesExpanded && partiesEditing}}" class="card-content">
      <view class="editable-list">
        <view class="list-header">
          <text class="list-title">ç¼–è¾‘ç›¸å…³æ–¹</text>
        </view>
        <view class="list-items">
          <view class="editable-item" wx:for="{{parties}}" wx:key="index">
            <view class="item-content">
              <text class="item-name">{{item.name}} Â· {{item.role}}</text>
              <text class="item-meta">{{item.type}} Â· {{item.contact || 'æ— è”ç³»æ–¹å¼'}}</text>
              <text class="item-sub">{{item.address || 'æ— åœ°å€'}}</text>
            </view>
            <view class="item-actions">
              <text class="delete-btn" bindtap="deletePartyItem" data-index="{{index}}">ğŸ—‘ï¸</text>
            </view>
          </view>
        </view>

        <!-- æ·»åŠ æŒ‰é’® -->
        <view wx:if="{{!showPartiesAddForm}}" class="add-trigger" bindtap="showPartiesAdd">
          <text class="add-trigger-icon">ï¼‹</text>
          <text class="add-trigger-text">æ·»åŠ ç›¸å…³æ–¹</text>
        </view>

        <!-- æ·»åŠ è¡¨å• -->
        <view wx:if="{{showPartiesAddForm}}" class="add-form">
          <view class="form-row">
            <input class="add-input" placeholder="å§“å" value="{{newPartyItem.name}}" bindinput="onPartyNameInput" />
          </view>
          <view class="form-row">
            <input class="add-input" placeholder="è§’è‰²" value="{{newPartyItem.role}}" bindinput="onPartyRoleInput" />
          </view>
          <view class="form-row">
            <input class="add-input" placeholder="ç±»å‹ï¼ˆä¸ªäºº/å…¬å¸ï¼‰" value="{{newPartyItem.type}}" bindinput="onPartyTypeInput" />
          </view>
          <view class="form-row">
            <input class="add-input" placeholder="è”ç³»æ–¹å¼" value="{{newPartyItem.contact}}" bindinput="onPartyContactInput" />
          </view>
          <view class="form-row">
            <input class="add-input" placeholder="åœ°å€" value="{{newPartyItem.address}}" bindinput="onPartyAddressInput" />
          </view>
          <view class="form-actions">
            <view class="cancel-small-btn" bindtap="hidePartiesAdd">å–æ¶ˆ</view>
            <view class="confirm-small-btn" bindtap="addPartyItem">ç¡®è®¤</view>
          </view>
        </view>

        <view class="edit-actions">
          <view class="cancel-btn" bindtap="cancelEditParties">å–æ¶ˆ</view>
          <view class="save-btn" bindtap="saveEditParties">ä¿å­˜</view>
        </view>
      </view>
    </view>

    <!-- æŠ˜å çŠ¶æ€ - åŠ¨æ€ç®€ç•¥æ˜¾ç¤ºï¼ˆå‰4æ¡ï¼‰ -->
    <view class="collapsed-content" wx:else>
      <view class="collapsed-items">
        <view class="collapsed-item" wx:for="{{parties.slice(0,4)}}" wx:key="index">
          <view class="collapsed-avatar {{item.roleClass}}">
            <text>{{item.id}}</text>
          </view>
          <text class="collapsed-text">{{item.name}} - {{item.role}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å®¢æˆ·æ“ä½œæŒ‰é’®æ  -->
  <view class="client-action-bar">
    <view class="action-btn bind-btn" bindtap="bindClient">
      <text class="btn-text">ç»‘å®šå®¢æˆ·</text>
    </view>
    <view class="action-btn contact-btn" bindtap="contactClient">
      <text class="btn-text">è”ç³»å®¢æˆ·</text>
    </view>
  </view>

  <!-- ç»‘å®šç æµ®çª—ï¼ˆä¸åˆ›å»ºæ¡ˆä»¶é¡µé¢é£æ ¼ä¸€è‡´ï¼‰ -->
  <view class="modal-overlay" wx:if="{{showBindModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title"> æ¡ˆä»¶ç»‘å®šç </text>
        <text class="close-btn" bindtap="closeBindModal">Ã—</text>
      </view>
      <view class="modal-body">
        <view class="bind-code-section">
          <text class="bind-code-label">ç»‘å®šç </text>
          <text class="bind-code-value">{{bindCode}}</text>
        </view>
        <text class="bind-tip">è¯·å°†æ­¤ç»‘å®šç å‘é€ç»™å®¢æˆ·ï¼Œå®¢æˆ·å¯åœ¨å°ç¨‹åºä¸­è¾“å…¥ç»‘å®šç å…³è”æ¡ˆä»¶ã€‚</text>
      </view>
      <view class="modal-actions">
        <view class="btn cancel-btn" bindtap="closeBindModal">ç¨å</view>
        <view class="btn confirm-btn" bindtap="copyBindCode">å¤åˆ¶ç»‘å®šç </view>
      </view>
    </view>
  </view>
</view>