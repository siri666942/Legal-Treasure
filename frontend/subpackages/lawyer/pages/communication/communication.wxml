<view class="page-container">
  <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
  <scroll-view 
    class="chat-content" 
    scroll-y 
    scroll-into-view="{{scrollToView}}" 
    scroll-with-animation
    enable-back-to-top
  >
    <view class="message-list">
      <block wx:for="{{messages}}" wx:key="id" wx:for-index="index">
        <!-- æ—¶é—´åˆ†éš”çº¿ -->
        <view class="message-divider" wx:if="{{item.type === 'divider'}}">
          <text class="divider-text">{{item.content}}</text>
        </view>

        <!-- æ­£å¸¸æ¶ˆæ¯ -->
        <block wx:else>
          <view 
            class="message-item {{item.sender === 'me' ? 'message-right' : 'message-left'}}" 
            id="msg-{{item.id}}"
          >
            <!-- å·¦ä¾§å¤´åƒ -->
            <view class="avatar" wx:if="{{item.sender === 'other'}}">
              <text class="avatar-text">{{chatTarget.name.charAt(0)}}</text>
            </view>

            <!-- æ¶ˆæ¯æ°”æ³¡ -->
            <view class="bubble">
              <!-- æ–‡æœ¬æ¶ˆæ¯ -->
              <view class="bubble-text" wx:if="{{item.type === 'text'}}">{{item.content}}</view>

              <!-- å›¾ç‰‡æ¶ˆæ¯ï¼ˆå•å‡»æ“ä½œèœå•ï¼‰ -->
              <view class="bubble-image" wx:elif="{{item.type === 'image'}}" bindtap="handleImageTap" data-filepath="{{item.filePath}}">
                <image class="image-preview" src="{{item.filePath}}" mode="aspectFill"></image>
              </view>

              <!-- æ–‡ä»¶æ¶ˆæ¯ï¼ˆå•å‡»æ“ä½œèœå•ï¼šé¢„è§ˆ/ä¸‹è½½ï¼‰ -->
              <view class="bubble-file" wx:elif="{{item.type === 'file'}}" bindtap="handleFileTap" data-filepath="{{item.filePath}}" data-filename="{{item.fileName}}">
                <view class="file-card {{item.sender === 'me' ? 'file-card-right' : 'file-card-left'}}">
                  <view class="file-icon">
                    <text>ğŸ“„</text>
                  </view>
                  <view class="file-info-wrapper">
                    <text class="file-name">{{item.fileName || 'æ–‡ä»¶'}}</text>
                    <text class="file-size">{{item.fileSize ? formatFileSize(item.fileSize) : ''}}</text>
                  </view>
                </view>
              </view>

              <!-- âœ¨ ä»»åŠ¡æ¶ˆæ¯å¡ç‰‡ï¼ˆæˆªæ­¢æ—¥æœŸç‰ˆï¼‰ -->
              <view class="bubble-task" wx:elif="{{item.type === 'task'}}">
                <view class="task-card {{item.sender === 'me' ? 'task-card-right' : 'task-card-left'}}">
                  <view class="task-icon">
                    <text>âœ…</text>
                  </view>
                  <view class="task-info-wrapper">
                    <text class="task-title">{{item.taskTitle}}</text>
                    <text class="task-desc" wx:if="{{item.description}}">{{item.description}}</text>
                    <text class="task-due">æˆªæ­¢ï¼š{{item.dueDate}}</text>
                  </view>
                  <view class="task-status {{item.completed ? 'completed' : 'pending'}}">
                    {{item.completed ? 'å·²å®Œæˆ' : 'å¾…å¤„ç†'}}
                  </view>
                </view>
              </view>

              <!-- è¯­éŸ³æ¶ˆæ¯ï¼ˆä»…ä¿ç•™æ’­æ”¾ï¼‰ -->
              <view class="bubble-voice" wx:elif="{{item.type === 'voice'}}" bindtap="playVoice" data-filepath="{{item.filePath}}" data-duration="{{item.duration}}">
                <view class="voice-wrapper">
                  <text class="voice-icon">ğŸ¤</text>
                  <view class="voice-wave">
                    <view class="wave-item"></view>
                    <view class="wave-item"></view>
                    <view class="wave-item"></view>
                    <view class="wave-item"></view>
                    <view class="wave-item"></view>
                  </view>
                  <text class="voice-duration">{{formatDuration(item.duration)}}</text>
                </view>
              </view>

              <!-- æ¶ˆæ¯æ—¶é—´ä¸çŠ¶æ€ï¼ˆå³ä¾§ï¼‰ -->
              <view class="bubble-footer" wx:if="{{item.sender === 'me'}}">
                <text class="bubble-time">{{formatTime(item.timestamp)}}</text>
                <view class="bubble-status">
                  <block wx:if="{{item.status === 'sending'}}"><text class="status-icon sending">ğŸ•</text></block>
                  <block wx:elif="{{item.status === 'sent'}}"><text class="status-icon sent">âœ“</text></block>
                  <block wx:elif="{{item.status === 'read'}}"><text class="status-icon read">âœ“âœ“</text></block>
                </view>
              </view>
              <!-- å·¦ä¾§æ¶ˆæ¯æ—¶é—´ï¼ˆæ— çŠ¶æ€ï¼‰ -->
              <view class="bubble-footer-left" wx:if="{{item.sender === 'other'}}">
                <text class="bubble-time">{{formatTime(item.timestamp)}}</text>
              </view>
            </view>

            <!-- å³ä¾§å¤´åƒï¼ˆè‡ªå·±ï¼‰ -->
            <view class="avatar avatar-self" wx:if="{{item.sender === 'me'}}">
              <text class="avatar-text">æˆ‘</text>
            </view>
          </view>
        </block>
      </block>
      <view id="bottom-anchor"></view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨è¾“å…¥æ ï¼ˆé™„ä»¶å·¦ä¾§ï¼Œå‘é€æŒ‰é’®å§‹ç»ˆå¯ç‚¹ï¼‰ -->
  <view class="input-area">
    <view class="input-wrapper">
      <!-- é™„ä»¶æŒ‰é’®ï¼ˆå·¦ä¾§ï¼‰ -->
      <view class="action-btn" bindtap="toggleAttachmentPanel">
        <text class="action-icon">+</text>
      </view>

      <!-- æ–‡æœ¬è¾“å…¥æ¡† -->
      <input 
        class="message-input" 
        placeholder="è¯·è¾“å…¥æ¶ˆæ¯" 
        placeholder-class="placeholder"
        value="{{inputValue}}"
        bindinput="onInput"
        bindconfirm="sendTextMessage"
        bindfocus="onInputFocus"
        bindblur="onInputBlur"
        focus="{{autoFocus}}"
        adjust-position="{{true}}"
      />

      <!-- å‘é€æŒ‰é’®ï¼ˆå§‹ç»ˆå¯ç‚¹ï¼Œæ ·å¼æ ¹æ®è¾“å…¥å˜åŒ–ï¼‰ -->
      <view class="send-btn {{inputValue.trim() ? 'active' : ''}}" bindtap="sendTextMessage">
        <text class="send-btn-text">å‘é€</text>
      </view>
    </view>

    <!-- é™„ä»¶é¢æ¿ï¼ˆå››åˆ—å¸ƒå±€ï¼‰ -->
    <view class="attachment-panel" wx:if="{{showAttachmentPanel}}">
      <view class="attachment-grid">
        <view class="attachment-item" bindtap="chooseImage">
          <view class="attachment-icon-bg">
            <text class="attachment-emoji">ğŸŒ„</text>
          </view>
          <text class="attachment-label">ç…§ç‰‡</text>
        </view>
        <view class="attachment-item" bindtap="chooseFile">
          <view class="attachment-icon-bg">
            <text class="attachment-emoji">ğŸ“</text>
          </view>
          <text class="attachment-label">æ–‡ä»¶</text>
        </view>
        <view class="attachment-item" bindtap="takePhoto">
          <view class="attachment-icon-bg">
            <text class="attachment-emoji">ğŸ“¸</text>
          </view>
          <text class="attachment-label">æ‹ç…§</text>
        </view>
        <!-- âœ¨ æ–°å»ºä»»åŠ¡å…¥å£ -->
        <view class="attachment-item" bindtap="showAddTaskModal">
          <view class="attachment-icon-bg">
            <text class="attachment-emoji">âœ…</text>
          </view>
          <text class="attachment-label">æ–°å»ºä»»åŠ¡</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ===== âœ¨ ä»»åŠ¡æµ®çª—ï¼ˆæˆªæ­¢æ—¥æœŸé€‰æ‹©ï¼‰===== -->
  <view class="modal-overlay" wx:if="{{showTaskModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">æ–°å»ºä»»åŠ¡</text>
        <text class="close-btn" bindtap="hideTaskModal">Ã—</text>
      </view>
      <view class="form-content">
        <!-- ä»»åŠ¡æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰ -->
        <view class="form-item">
          <text class="form-label">ä»»åŠ¡æ ‡é¢˜</text>
          <input 
            class="form-input" 
            placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜" 
            value="{{taskForm.title}}"
            bindinput="onTaskTitleInput"
            placeholder-class="placeholder"
          />
        </view>
        <!-- æˆªæ­¢æ—¥æœŸï¼ˆæ—¥æœŸé€‰æ‹©å™¨ï¼‰ -->
        <view class="form-item">
          <text class="form-label">æˆªæ­¢æ—¥æœŸ</text>
          <picker mode="date" value="{{taskForm.dueDate}}" bindchange="onDueDateChange">
            <view class="form-input date-picker">
              {{taskForm.dueDate || 'è¯·é€‰æ‹©æ—¥æœŸ'}}
            </view>
          </picker>
        </view>
        <!-- æè¿°ï¼ˆå¯é€‰ï¼‰ -->
        <view class="form-item">
          <text class="form-label">æè¿°ï¼ˆå¯é€‰ï¼‰</text>
          <textarea 
            class="form-textarea" 
            placeholder="è¯·è¾“å…¥ä»»åŠ¡æè¿°" 
            value="{{taskForm.description}}"
            bindinput="onTaskDescriptionInput"
            maxlength="200"
            placeholder-class="placeholder"
          />
        </view>
      </view>
      <view class="modal-actions">
        <view class="btn cancel-btn" bindtap="hideTaskModal">å–æ¶ˆ</view>
        <view class="btn confirm-btn" bindtap="saveNewTask">ä¿å­˜</view>
      </view>
    </view>
  </view>
</view>